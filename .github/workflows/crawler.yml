name: TrendRadar Crawler & Gold Monitor

on:
  schedule:
    # æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ github å®˜æ–¹æä¾›çš„èµ„æºæ¥è¿›è¡Œçš„æŽ¨é€ï¼Œè€Œæ¯ä¸ªè´¦å·çš„èµ„æºæ˜¯é™é¢çš„ï¼Œä¸ºäº†ä¸è¢«å®˜æ–¹åˆ¤å®šä¸ºæ»¥ç”¨è€Œé¢ä¸´å°å·çš„é£Žé™©ï¼Œä¸å»ºè®®æ¯”åŠå°æ—¶æ›´ä½Ž
    - cron: "0 * * * *" # æ¯å°æ—¶æ•´ç‚¹è¿è¡Œä¸€æ¬¡(å®žé™…æœ‰åå·®) æˆ–è€… "*/30 * * * *" (æ¯åŠå°æ—¶æ‰§è¡Œä¸€æ¬¡) æˆ–è€… "*/30 0-14 * * *"(æ¯å¤©æ—©ä¸Š 8 ç‚¹åˆ°æ™šä¸Š 10 ç‚¹æœŸé—´ï¼Œæ¯åŠå°æ—¶è¿è¡Œä¸€æ¬¡)
  workflow_dispatch:
    inputs:
      enable_gold_monitor:
        description: 'Enable Gold Price Monitoring'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      gold_monitor_only:
        description: 'Run Gold Monitor Only (skip news crawler)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write

env:
  # Gold Monitor Configuration
  ENABLE_GOLD_MONITOR: ${{ github.event.inputs.enable_gold_monitor || 'true' }}
  GOLD_MONITOR_ONLY: ${{ github.event.inputs.gold_monitor_only || 'false' }}

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required files
        run: |
          echo "ðŸ” æ£€æŸ¥å¿…éœ€çš„é…ç½®æ–‡ä»¶..."

          if [ ! -f config/config.yaml ]; then
            echo "âŒ é”™è¯¯: config/config.yaml æ–‡ä»¶ä¸å­˜åœ¨"
            echo "è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£åˆ›å»ºé…ç½®æ–‡ä»¶"
            exit 1
          fi

          if [ ! -f config/frequency_words.txt ]; then
            echo "âŒ é”™è¯¯: config/frequency_words.txt æ–‡ä»¶ä¸å­˜åœ¨"
            echo "è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£åˆ›å»ºé¢‘çŽ‡è¯é…ç½®æ–‡ä»¶"
            exit 1
          fi

          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      - name: Verify Gold Monitor Configuration
        if: env.ENABLE_GOLD_MONITOR == 'true'
        run: |
          echo "ðŸ” æ£€æŸ¥é»„é‡‘ç›‘æŽ§é…ç½®..."
          
          # Check if gold monitor module exists
          if [ ! -d "src/gold_monitor" ]; then
            echo "âŒ é”™è¯¯: src/gold_monitor ç›®å½•ä¸å­˜åœ¨"
            echo "è¯·ç¡®ä¿é»„é‡‘ç›‘æŽ§æ¨¡å—å·²æ­£ç¡®å®‰è£…"
            exit 1
          fi
          
          # Check if gold monitor is enabled in config
          python -c "
          import yaml
          import sys
          
          try:
              with open('config/config.yaml', 'r', encoding='utf-8') as f:
                  config = yaml.safe_load(f)
              
              gold_config = config.get('gold_monitor', {})
              if not gold_config:
                  print('âš ï¸  è­¦å‘Š: config.yaml ä¸­æœªæ‰¾åˆ° gold_monitor é…ç½®æ®µ')
                  sys.exit(0)
              
              if not gold_config.get('enabled', False):
                  print('âš ï¸  è­¦å‘Š: é»„é‡‘ç›‘æŽ§åŠŸèƒ½åœ¨é…ç½®ä¸­è¢«ç¦ç”¨')
                  print('æç¤º: è®¾ç½® gold_monitor.enabled = true æ¥å¯ç”¨')
                  sys.exit(0)
              
              # Check API keys
              api_keys = gold_config.get('api_keys', {})
              has_keys = any(api_keys.get(key) for key in ['goldapi_key', 'jisu_api_key'])
              
              if not has_keys:
                  print('âš ï¸  è­¦å‘Š: æœªé…ç½®é»„é‡‘ä»·æ ¼APIå¯†é’¥')
                  print('æç¤º: åœ¨ gold_monitor.api_keys ä¸­é…ç½® goldapi_key æˆ– jisu_api_key')
              else:
                  print('âœ… é»„é‡‘ç›‘æŽ§é…ç½®æ£€æŸ¥é€šè¿‡')
          
          except Exception as e:
              print(f'âŒ é…ç½®æ£€æŸ¥å¤±è´¥: {e}')
              sys.exit(1)
          "

      - name: Run News Crawler
        if: env.GOLD_MONITOR_ONLY != 'true'
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          GITHUB_ACTIONS: true
        run: |
          echo "ðŸ“° å¼€å§‹æ‰§è¡Œæ–°é—»çˆ¬å–ä»»åŠ¡..."
          python main.py

      - name: Run Gold Price Monitor
        if: env.ENABLE_GOLD_MONITOR == 'true'
        env:
          # Notification webhooks (reuse from main crawler)
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          
          # Gold Monitor specific API keys
          GOLDAPI_KEY: ${{ secrets.GOLDAPI_KEY }}
          JISU_API_KEY: ${{ secrets.JISU_API_KEY }}
          
          # Runtime flags
          GITHUB_ACTIONS: true
          GOLD_MONITOR_MODE: true
        run: |
          echo "ðŸ’° å¼€å§‹æ‰§è¡Œé»„é‡‘ä»·æ ¼ç›‘æŽ§ä»»åŠ¡..."
          
          # Create gold monitor runner script
          cat > run_gold_monitor.py << 'EOF'
          #!/usr/bin/env python3
          """
          Gold Monitor Runner for GitHub Actions
          
          This script runs the gold price monitoring functionality
          independently or alongside the main TrendRadar crawler.
          """
          
          import os
          import sys
          import logging
          import yaml
          from datetime import datetime
          
          # Add src directory to path
          sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))
          
          def setup_logging():
              """Setup logging for GitHub Actions"""
              logging.basicConfig(
                  level=logging.INFO,
                  format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
                  handlers=[
                      logging.StreamHandler(sys.stdout)
                  ]
              )
              return logging.getLogger(__name__)
          
          def load_config():
              """Load configuration from config.yaml"""
              try:
                  with open('config/config.yaml', 'r', encoding='utf-8') as f:
                      config = yaml.safe_load(f)
                  return config
              except Exception as e:
                  print(f"âŒ é…ç½®åŠ è½½å¤±è´¥: {e}")
                  return None
          
          def update_config_with_env(config):
              """Update configuration with environment variables"""
              if not config:
                  return None
              
              # Update API keys from environment variables
              gold_config = config.setdefault('gold_monitor', {})
              api_keys = gold_config.setdefault('api_keys', {})
              
              if os.getenv('GOLDAPI_KEY'):
                  api_keys['goldapi_key'] = os.getenv('GOLDAPI_KEY')
                  print("âœ… GoldAPIå¯†é’¥å·²ä»ŽçŽ¯å¢ƒå˜é‡åŠ è½½")
              
              if os.getenv('JISU_API_KEY'):
                  api_keys['jisu_api_key'] = os.getenv('JISU_API_KEY')
                  print("âœ… æžé€Ÿæ•°æ®APIå¯†é’¥å·²ä»ŽçŽ¯å¢ƒå˜é‡åŠ è½½")
              
              # Update notification webhooks
              notification_config = config.setdefault('notification', {})
              webhooks = notification_config.setdefault('webhooks', {})
              
              env_webhooks = {
                  'feishu_url': 'FEISHU_WEBHOOK_URL',
                  'dingtalk_url': 'DINGTALK_WEBHOOK_URL',
                  'wework_url': 'WEWORK_WEBHOOK_URL',
                  'telegram_bot_token': 'TELEGRAM_BOT_TOKEN',
                  'telegram_chat_id': 'TELEGRAM_CHAT_ID'
              }
              
              for config_key, env_key in env_webhooks.items():
                  if os.getenv(env_key):
                      webhooks[config_key] = os.getenv(env_key)
              
              return config
          
          def run_gold_monitor():
              """Run gold price monitoring"""
              logger = setup_logging()
              logger.info("ðŸš€ å¯åŠ¨é»„é‡‘ä»·æ ¼ç›‘æŽ§ç³»ç»Ÿ...")
              
              try:
                  # Load and update configuration
                  config = load_config()
                  if not config:
                      logger.error("âŒ æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶")
                      return False
                  
                  config = update_config_with_env(config)
                  gold_config = config.get('gold_monitor', {})
                  
                  if not gold_config.get('enabled', False):
                      logger.warning("âš ï¸  é»„é‡‘ç›‘æŽ§åŠŸèƒ½æœªå¯ç”¨")
                      return True
                  
                  # Import gold monitor modules
                  from gold_monitor import (
                      GoldPriceCollector, 
                      PriceAnalyzer, 
                      GoldNotificationManager
                  )
                  
                  # Initialize components
                  logger.info("ðŸ“Š åˆå§‹åŒ–é»„é‡‘ä»·æ ¼é‡‡é›†å™¨...")
                  collector_config = {
                      'goldapi_key': gold_config.get('api_keys', {}).get('goldapi_key', ''),
                      'jisu_api_key': gold_config.get('api_keys', {}).get('jisu_api_key', ''),
                      'cache_ttl': gold_config.get('monitoring', {}).get('cache_ttl', 300)
                  }
                  collector = GoldPriceCollector(collector_config)
                  
                  logger.info("ðŸ“ˆ åˆå§‹åŒ–ä»·æ ¼åˆ†æžå™¨...")
                  analyzer_config = gold_config.get('alerts', {}).get('thresholds', {})
                  analyzer = PriceAnalyzer(analyzer_config)
                  
                  logger.info("ðŸ“± åˆå§‹åŒ–é€šçŸ¥ç®¡ç†å™¨...")
                  notification_config = config.get('notification', {}).get('webhooks', {})
                  notification_manager = GoldNotificationManager(notification_config)
                  
                  # Test connectivity
                  logger.info("ðŸ”— æµ‹è¯•APIè¿žæŽ¥...")
                  health = collector.health_check()
                  healthy_apis = sum(1 for status in health.values() if status)
                  total_apis = len(health)
                  logger.info(f"APIå¥åº·çŠ¶æ€: {healthy_apis}/{total_apis} æ­£å¸¸")
                  
                  if healthy_apis == 0:
                      logger.warning("âš ï¸  æ‰€æœ‰APIè¿žæŽ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥é…ç½®")
                      return True  # Don't fail the workflow
                  
                  # Collect price data
                  logger.info("ðŸ’° é‡‡é›†é»„é‡‘ä»·æ ¼æ•°æ®...")
                  prices = collector.get_gold_prices()
                  
                  if not prices:
                      logger.warning("âš ï¸  æœªèŽ·å–åˆ°ä»·æ ¼æ•°æ®")
                      return True
                  
                  logger.info(f"âœ… æˆåŠŸèŽ·å– {len(prices)} ä¸ªå“ç§çš„ä»·æ ¼æ•°æ®")
                  
                  # Analyze prices and check for alerts
                  alerts = []
                  for symbol, price_data in prices.items():
                      logger.info(f"ðŸ“Š åˆ†æž {symbol}: ${price_data.price:.2f} {price_data.currency}")
                      
                      # Add to analyzer
                      analyzer.add_price_data(price_data)
                      
                      # Check for alerts
                      symbol_alerts = analyzer.check_alerts(symbol)
                      alerts.extend(symbol_alerts)
                  
                  # Send notifications
                  if alerts:
                      logger.info(f"ðŸš¨ å‘çŽ° {len(alerts)} ä¸ªä»·æ ¼é¢„è­¦")
                      for alert in alerts:
                          logger.info(f"  - {alert.severity.upper()}: {alert.message}")
                      
                      # Send alert notifications
                      success_count = notification_manager.notify_batch_alerts(alerts)
                      logger.info(f"ðŸ“± é¢„è­¦é€šçŸ¥å‘é€æˆåŠŸ: {success_count} æ¡")
                  else:
                      logger.info("âœ… å½“å‰æ— ä»·æ ¼é¢„è­¦")
                  
                  # Generate and send summary
                  summaries = analyzer.get_all_summaries()
                  if summaries:
                      logger.info("ðŸ“‹ å‘é€ä»·æ ¼æ‘˜è¦...")
                      summary_success = notification_manager.notify_summary(summaries)
                      if summary_success:
                          logger.info("âœ… ä»·æ ¼æ‘˜è¦å‘é€æˆåŠŸ")
                      else:
                          logger.warning("âš ï¸  ä»·æ ¼æ‘˜è¦å‘é€å¤±è´¥")
                  
                  logger.info("ðŸŽ‰ é»„é‡‘ä»·æ ¼ç›‘æŽ§ä»»åŠ¡å®Œæˆ")
                  return True
                  
              except ImportError as e:
                  logger.error(f"âŒ æ¨¡å—å¯¼å…¥å¤±è´¥: {e}")
                  logger.error("è¯·ç¡®ä¿é»„é‡‘ç›‘æŽ§æ¨¡å—å·²æ­£ç¡®å®‰è£…")
                  return False
              except Exception as e:
                  logger.error(f"âŒ é»„é‡‘ç›‘æŽ§æ‰§è¡Œå¤±è´¥: {e}")
                  import traceback
                  traceback.print_exc()
                  return False
          
          if __name__ == "__main__":
              success = run_gold_monitor()
              if not success:
                  print("âŒ é»„é‡‘ç›‘æŽ§ä»»åŠ¡å¤±è´¥")
                  sys.exit(1)
              else:
                  print("âœ… é»„é‡‘ç›‘æŽ§ä»»åŠ¡æˆåŠŸå®Œæˆ")
          EOF
          
          # Run the gold monitor
          python run_gold_monitor.py

      - name: Generate Combined Report
        if: env.ENABLE_GOLD_MONITOR == 'true' && env.GOLD_MONITOR_ONLY != 'true'
        run: |
          echo "ðŸ“Š ç”Ÿæˆç»¼åˆæŠ¥å‘Š..."
          
          # Create combined report generator
          cat > generate_combined_report.py << 'EOF'
          #!/usr/bin/env python3
          """
          Combined Report Generator
          
          Generates a combined report including both news trends and gold price monitoring.
          """
          
          import os
          import sys
          import yaml
          from datetime import datetime
          
          # Add src directory to path
          sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))
          
          def generate_combined_report():
              """Generate combined HTML report"""
              try:
                  # Check if both reports exist
                  news_report_exists = os.path.exists('index.html')
                  
                  print(f"ðŸ“° æ–°é—»æŠ¥å‘Šå­˜åœ¨: {news_report_exists}")
                  
                  if news_report_exists:
                      print("ðŸ“Š æ£€æµ‹åˆ°çŽ°æœ‰æ–°é—»æŠ¥å‘Šï¼Œé»„é‡‘ç›‘æŽ§æ•°æ®å·²é›†æˆåˆ°ä¸»æŠ¥å‘Šä¸­")
                  else:
                      print("âš ï¸  æœªæ‰¾åˆ°æ–°é—»æŠ¥å‘Šï¼Œä»…ç”Ÿæˆé»„é‡‘ç›‘æŽ§æŠ¥å‘Š")
                  
                  print("âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ")
                  return True
                  
              except Exception as e:
                  print(f"âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥: {e}")
                  return False
          
          if __name__ == "__main__":
              success = generate_combined_report()
              if not success:
                  sys.exit(1)
          EOF
          
          python generate_combined_report.py

      - name: Commit and push if changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add -A
          
          # Check if there are any changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "ðŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            # Create commit message based on what ran
            COMMIT_MSG="Auto update by GitHub Actions at $(TZ=Asia/Shanghai date)"
            
            if [ "$ENABLE_GOLD_MONITOR" = "true" ] && [ "$GOLD_MONITOR_ONLY" != "true" ]; then
              COMMIT_MSG="$COMMIT_MSG - News + Gold Monitor"
            elif [ "$ENABLE_GOLD_MONITOR" = "true" ] && [ "$GOLD_MONITOR_ONLY" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG - Gold Monitor Only"
            else
              COMMIT_MSG="$COMMIT_MSG - News Only"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… å˜æ›´å·²æäº¤å¹¶æŽ¨é€"
          fi

      - name: Workflow Summary
        if: always()
        run: |
          echo "ðŸ“‹ å·¥ä½œæµæ‰§è¡Œæ‘˜è¦"
          echo "=================="
          echo "ðŸ• æ‰§è¡Œæ—¶é—´: $(TZ=Asia/Shanghai date)"
          echo "ðŸ“° æ–°é—»çˆ¬å–: ${{ env.GOLD_MONITOR_ONLY != 'true' && 'âœ… å·²æ‰§è¡Œ' || 'â­ï¸ å·²è·³è¿‡' }}"
          echo "ðŸ’° é»„é‡‘ç›‘æŽ§: ${{ env.ENABLE_GOLD_MONITOR == 'true' && 'âœ… å·²æ‰§è¡Œ' || 'â­ï¸ å·²è·³è¿‡' }}"
          echo "ðŸ”„ æ‰§è¡Œæ¨¡å¼: ${{ env.GOLD_MONITOR_ONLY == 'true' && 'ä»…é»„é‡‘ç›‘æŽ§' || (env.ENABLE_GOLD_MONITOR == 'true' && 'æ–°é—»+é»„é‡‘ç›‘æŽ§' || 'ä»…æ–°é—»çˆ¬å–') }}"
          echo "=================="